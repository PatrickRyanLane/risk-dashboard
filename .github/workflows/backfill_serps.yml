name: Backfill Brand & CEO SERPs

on:
  workflow_dispatch:
    inputs:
      start:
        description: "Start date (YYYY-MM-DD)"
        default: "2025-09-15"
        required: true
      end:
        description: "End date (YYYY-MM-DD, defaults to today)"
        required: false

jobs:
  backfill:
    runs-on: ubuntu-latest
    env:
      GCS_BUCKET: risk-dashboard
      PYTHONPATH: ${{ github.workspace }}
    
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          sparse-checkout: |
            requirements.txt
            scripts/
            rosters/
            storage_utils.py
            .github/
          sparse-checkout-cone-mode: false

      - name: Verify checkout
        run: |
          echo "ðŸ“‚ Workspace contents:"
          ls -la
          echo "âœ… storage_utils.py exists:" && test -f storage_utils.py && echo "YES" || echo "NO"
          echo "âœ… rosters/ exists:" && test -d rosters && echo "YES" || echo "NO"
          
      - name: Setup Python environment
        uses: ./.github/actions/setup-python-env

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCS_SERVICE_ACCOUNT_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Backfill brand SERPs (â†’ GCS)
        shell: bash
        env:
          START: ${{ github.event.inputs.start }}
          ENDIN: ${{ github.event.inputs.end }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          set -euo pipefail
          python - <<'PY'
          import os, sys, subprocess, datetime as dt
          start = os.environ["START"]
          end   = os.environ.get("ENDIN") or dt.date.today().isoformat()
          bucket = os.environ.get("GCS_BUCKET", "risk-dashboard")
          d = dt.date.fromisoformat(start)
          end_d = dt.date.fromisoformat(end)
          while d <= end_d:
            s = d.isoformat()
            print(f"[brand] {s}")
            rc = subprocess.call([
              sys.executable, "scripts/process_serps_brands.py", 
              "--date", s, 
              "--bucket", bucket
            ])
            if rc != 0:
              print(f"[brand][skip] {s} (no raw SERP or non-fatal error)")
            d += dt.timedelta(days=1)
          PY

      - name: Backfill CEO SERPs (â†’ GCS)
        shell: bash
        env:
          START: ${{ github.event.inputs.start }}
          ENDIN: ${{ github.event.inputs.end }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          set -euo pipefail
          python - <<'PY'
          import os, sys, subprocess, datetime as dt
          start = os.environ["START"]
          end   = os.environ.get("ENDIN") or dt.date.today().isoformat()
          bucket = os.environ.get("GCS_BUCKET", "risk-dashboard")
          d = dt.date.fromisoformat(start)
          end_d = dt.date.fromisoformat(end)
          while d <= end_d:
            s = d.isoformat()
            print(f"[ceo] {s}")
            rc = subprocess.call([
              sys.executable, "scripts/process_serps_ceos.py", 
              "--date", s, 
              "--bucket", bucket
            ])
            if rc != 0:
              print(f"[ceo][skip] {s} (no raw SERP or non-fatal error)")
            d += dt.timedelta(days=1)
          PY

      - name: Summary
        if: always()
        env:
          START_IN: ${{ github.event.inputs.start }}
          END_IN: ${{ github.event.inputs.end }}
        run: |
          START_DATE="${START_IN:-manual}"
          END_DATE="${END_IN:-$(date -u +%F)}"
          
          echo "### SERP Backfill Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“… **Range:** ${START_DATE} to ${END_DATE}" >> $GITHUB_STEP_SUMMARY
          echo "â˜ï¸ **Bucket:** gs://$GCS_BUCKET" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Files written:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          gsutil ls "gs://$GCS_BUCKET/data/processed_serps/" 2>/dev/null | tail -20 || echo "No files"
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
