name: Daily Brands Pipeline

on:
  workflow_dispatch:
    inputs:
      date:
        description: "Run date in UTC (YYYY-MM-DD). Leave blank for today."
        required: false
        type: string
  schedule:
    - cron: "10 9 * * *"   # 05:10 ET daily

permissions:
  contents: read
  id-token: write

concurrency:
  group: daily-brands
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      GCS_BUCKET: risk-dashboard
      PYTHONPATH: ${{ github.workspace }}  # Allows 'from storage_utils import ...'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          sparse-checkout: |
            requirements.txt
            scripts/
            storage_utils.py
            .github/
          sparse-checkout-cone-mode: false

      # Debug: verify files were checked out
      - name: Verify checkout
        run: |
          echo "ðŸ“‚ Workspace: ${{ github.workspace }}"
          echo "ðŸ“‚ Files in workspace:"
          ls -la
          echo ""
          echo "ðŸ“‚ Files in scripts/:"
          ls -la scripts/
          echo ""
          echo "âœ… storage_utils.py exists:" && test -f storage_utils.py && echo "YES" || echo "NO"
          echo "ðŸ“ PYTHONPATH: $PYTHONPATH"

      - name: Setup Python environment
        uses: ./.github/actions/setup-python-env

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCS_SERVICE_ACCOUNT_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Verify GCS access
        run: |
          echo "Testing GCS access..."
          gsutil ls gs://$GCS_BUCKET/rosters/ || echo "Warning: Could not list rosters"

      - name: Build brand articles (â†’ GCS)
        env:
          RUN_DATE: ${{ github.event.inputs.date || '' }}
        run: |
          set -euo pipefail
          DATE_TO_RUN="${RUN_DATE:-$(date -u +%F)}"
          echo "ðŸš€ Running news_articles_brands.py for ${DATE_TO_RUN}"
          echo "ðŸ“¦ Batch size: 1500 (all companies in one run)"
          python scripts/news_articles_brands.py \
            --date "${DATE_TO_RUN}" \
            --bucket "$GCS_BUCKET" \
            --batch-size 1500

      - name: Aggregate brand news sentiment (â†’ GCS)
        env:
          RUN_DATE: ${{ github.event.inputs.date || '' }}
        run: |
          set -euo pipefail
          DATE_TO_RUN="${RUN_DATE:-$(date -u +%F)}"
          echo "ðŸ“Š Running news_sentiment_brands.py for ${DATE_TO_RUN}"
          python scripts/news_sentiment_brands.py \
            --date "${DATE_TO_RUN}" \
            --bucket "$GCS_BUCKET"

      - name: Process brand SERPs (â†’ GCS)
        env:
          RUN_DATE: ${{ github.event.inputs.date || '' }}
        run: |
          set -euo pipefail
          DATE_TO_RUN="${RUN_DATE:-$(date -u +%F)}"
          echo "ðŸ” Processing brand SERPs for ${DATE_TO_RUN}"
          python scripts/process_serps_brands.py \
            --date "${DATE_TO_RUN}" \
            --bucket "$GCS_BUCKET"

      - name: Summary
        if: always()
        env:
          RUN_DATE: ${{ github.event.inputs.date || '' }}
        run: |
          DATE_TO_USE="${RUN_DATE:-$(date -u +%F)}"
          
          echo "### Daily Brands Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“… **Date:** ${DATE_TO_USE}" >> $GITHUB_STEP_SUMMARY
          echo "â˜ï¸ **Bucket:** gs://$GCS_BUCKET" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "#### Files written to GCS:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          gsutil ls -l "gs://$GCS_BUCKET/data/processed_articles/${DATE_TO_USE}*" 2>/dev/null || echo "No article files found"
          gsutil ls -l "gs://$GCS_BUCKET/data/daily_counts/brand*" 2>/dev/null || echo "No daily counts found"
          gsutil ls -l "gs://$GCS_BUCKET/data/processed_serps/${DATE_TO_USE}*brand*" 2>/dev/null || echo "No SERP files found"
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
