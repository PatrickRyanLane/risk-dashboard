name: Send Alerts

on:
  workflow_run:
    workflows:
      - "Daily Brands Pipeline"
      - "Daily CEO Pipeline"
    types: [completed]
  repository_dispatch:
    types: [send_alerts]
  workflow_dispatch:
    inputs:
      alert_send_mode:
        description: "How to deliver: same_morning (default) or next_morning"
        required: false
        default: "same_morning"
        type: choice
        options: [same_morning, next_morning]
      negative_threshold:
        description: "Alert threshold (0.0 - 1.0). Leave blank to use default/vars."
        required: false
        type: string
      cooldown_days:
        description: "Cooldown in days. Leave blank to use default/vars."
        required: false
        type: string
      soft_shift_hours:
        description: "Treat runs before this ET hour as previous day. Leave blank to use default/vars."
        required: false
        type: string

permissions:
  contents: read
  id-token: write

concurrency:
  group: send-alerts
  cancel-in-progress: false

jobs:
  send-alerts:
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    env:
      GCS_BUCKET: risk-dashboard
      PYTHONPATH: ${{ github.workspace }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          sparse-checkout: |
            requirements.txt
            scripts/
            storage_utils.py
            rosters/
            .github/
          sparse-checkout-cone-mode: false

      - name: Verify checkout
        run: |
          echo "ðŸ“‚ Workspace contents:"
          ls -la
          echo "âœ… storage_utils.py exists:" && test -f storage_utils.py && echo "YES" || echo "NO"

      - name: Setup Python environment
        uses: ./.github/actions/setup-python-env

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCS_SERVICE_ACCOUNT_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # Download recent data from GCS for alert processing
      - name: Download data from GCS
        run: |
          echo "ðŸ“¥ Downloading recent data from GCS..."
          mkdir -p data/processed_articles
          mkdir -p data/processed_serps
          mkdir -p data/daily_counts
          mkdir -p data/email_alerts
          
          # Get today's date and yesterday's date
          TODAY=$(date -u +%F)
          YESTERDAY=$(date -u -d "yesterday" +%F 2>/dev/null || date -u -v-1d +%F)
          
          # Download recent article files (last 2 days)
          echo "ðŸ“„ Downloading article files..."
          gsutil -m cp "gs://$GCS_BUCKET/data/processed_articles/${TODAY}*" data/processed_articles/ 2>/dev/null || echo "No files for today"
          gsutil -m cp "gs://$GCS_BUCKET/data/processed_articles/${YESTERDAY}*" data/processed_articles/ 2>/dev/null || echo "No files for yesterday"
          
          # Download recent SERP files
          echo "ðŸ” Downloading SERP files..."
          gsutil -m cp "gs://$GCS_BUCKET/data/processed_serps/${TODAY}*" data/processed_serps/ 2>/dev/null || echo "No SERP files for today"
          gsutil -m cp "gs://$GCS_BUCKET/data/processed_serps/${YESTERDAY}*" data/processed_serps/ 2>/dev/null || echo "No SERP files for yesterday"
          
          # Download daily counts
          echo "ðŸ“Š Downloading daily counts..."
          gsutil -m cp "gs://$GCS_BUCKET/data/daily_counts/*" data/daily_counts/ 2>/dev/null || echo "No daily counts"
          
          # List what we downloaded
          echo ""
          echo "ðŸ“‚ Downloaded files:"
          find data -type f -name "*.csv" | head -20

      - name: Download last cooldown artifact
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: send_alerts.yml
          workflow_conclusion: success
          branch: main
          name: cooldown-state
          path: .
          if_no_artifact_found: ignore

      - name: Run alert sender
        env:
          MAILGUN_API_KEY: ${{ secrets.MAILGUN_API_KEY }}
          MAILGUN_DOMAIN: ${{ secrets.MAILGUN_DOMAIN }}
          MAILGUN_FROM: ${{ secrets.MAILGUN_FROM }}
          MAILGUN_TO: ${{ secrets.MAILGUN_TO }}
          MAILGUN_REGION: ${{ secrets.MAILGUN_REGION }}
          ALERT_SEND_MODE: ${{ github.event.inputs.alert_send_mode || vars.ALERT_SEND_MODE || 'same_morning' }}
          NEGATIVE_THRESHOLD: ${{ github.event.inputs.negative_threshold || vars.NEGATIVE_THRESHOLD || '0.4' }}
          ALERT_COOLDOWN_DAYS: ${{ github.event.inputs.cooldown_days || vars.ALERT_COOLDOWN_DAYS || '180' }}
          SOFT_SHIFT_HOURS: ${{ github.event.inputs.soft_shift_hours || vars.SOFT_SHIFT_HOURS || '6' }}
        run: |
          python -m scripts.send_alerts
          
      - name: Upload cooldown state
        if: success() && hashFiles('data/email_alerts/last_alert_dates.json') != ''
        uses: actions/upload-artifact@v4
        with:
          name: cooldown-state
          path: data/email_alerts/last_alert_dates.json
          if-no-files-found: warn
          retention-days: 365
