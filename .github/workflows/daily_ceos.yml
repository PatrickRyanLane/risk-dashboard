name: Daily CEO Pipeline

on:
  schedule:
    - cron: "10 10 * * *"   # 06:10 ET (one hour after brands)
  workflow_dispatch:
    inputs:
      date:
        description: "Run date in UTC (YYYY-MM-DD). Leave blank for today."
        required: false
        type: string

permissions:
  contents: read
  id-token: write

concurrency:
  group: daily-ceos
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      PYTHONUNBUFFERED: '1'
      TZ: America/New_York
      GCS_BUCKET: risk-dashboard
      PYTHONPATH: ${{ github.workspace }}

    steps:
      - name: Check out repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          sparse-checkout: |
            requirements.txt
            scripts/
            storage_utils.py
            .github/
          sparse-checkout-cone-mode: false

      - name: Verify checkout
        run: |
          echo "ðŸ“‚ Workspace: ${{ github.workspace }}"
          ls -la
          echo "âœ… storage_utils.py exists:" && test -f storage_utils.py && echo "YES" || echo "NO"

      - name: Setup Python environment
        uses: ./.github/actions/setup-python-env

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCS_SERVICE_ACCOUNT_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Verify GCS access
        run: |
          echo "Testing GCS access..."
          gsutil ls gs://$GCS_BUCKET/rosters/ || echo "Warning: Could not list rosters"

      - name: Build daily CEO articles (â†’ GCS)
        env:
          RUN_DATE: ${{ github.event.inputs.date || '' }}
          ARTICLES_MAX_PER_ALIAS: "25"
          ARTICLES_SLEEP_SEC: "0.35"
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          DATE_TO_RUN="${RUN_DATE:-$(date -u +%F)}"
          echo "ðŸš€ Running news_articles_ceos.py for ${DATE_TO_RUN}"
          python scripts/news_articles_ceos.py \
            --date "${DATE_TO_RUN}" \
            --bucket "$GCS_BUCKET" \
            --batch-size 1500

      - name: Run daily CEO sentiment (â†’ GCS)
        env:
          RUN_DATE: ${{ github.event.inputs.date || '' }}
        run: |
          DATE_TO_RUN="${RUN_DATE:-$(date -u +%F)}"
          echo "ðŸ“Š Running news_sentiment_ceos.py for ${DATE_TO_RUN}"
          python scripts/news_sentiment_ceos.py \
            --date "${DATE_TO_RUN}" \
            --bucket "$GCS_BUCKET"

      - name: Process CEO SERPs (â†’ GCS)
        env:
          RUN_DATE: ${{ github.event.inputs.date || '' }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          DATE_TO_RUN="${RUN_DATE:-$(date -u +%F)}"
          echo "ðŸ” Processing CEO SERPs for ${DATE_TO_RUN}"
          python scripts/process_serps_ceos.py \
            --date "${DATE_TO_RUN}" \
            --bucket "$GCS_BUCKET"

      - name: Summary
        if: always()
        env:
          RUN_DATE: ${{ github.event.inputs.date || '' }}
        run: |
          DATE_TO_USE="${RUN_DATE:-$(date -u +%F)}"
          
          echo "### Daily CEO Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“… **Date:** ${DATE_TO_USE}" >> $GITHUB_STEP_SUMMARY
          echo "â˜ï¸ **Bucket:** gs://$GCS_BUCKET" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "#### Files written to GCS:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          gsutil ls -l "gs://$GCS_BUCKET/data/processed_articles/${DATE_TO_USE}*ceo*" >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "No CEO article files" >> $GITHUB_STEP_SUMMARY
          gsutil ls -l "gs://$GCS_BUCKET/data/daily_counts/ceo*" >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "No CEO counts" >> $GITHUB_STEP_SUMMARY
          gsutil ls -l "gs://$GCS_BUCKET/data/processed_serps/${DATE_TO_USE}*ceo*" >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "No CEO SERP files" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

          echo "#### DB write status:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "Check logs for: âœ… DB upserted ... rows" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
