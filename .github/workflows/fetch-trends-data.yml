name: Fetch Trends Data (Batched)

on:
  schedule:
    - cron: '30 14 * * 1-5'  # Batch 1: 10:30am ET
    - cron: '0 18 * * 1-5'   # Batch 2: 2:00pm ET
    - cron: '0 22 * * 1-5'   # Batch 3: 6:00pm ET
  workflow_dispatch:
    inputs:
      batch:
        description: 'Batch number (1, 2, or 3). Leave empty to run all batches.'
        required: false
        type: string

permissions:
  contents: read
  id-token: write

jobs:
  fetch-trends:
    runs-on: ubuntu-latest
    env:
      GCS_BUCKET: risk-dashboard
      PYTHONPATH: ${{ github.workspace }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          sparse-checkout: |
            requirements.txt
            scripts/
            storage_utils.py
            .github/
          sparse-checkout-cone-mode: false

      - name: Verify checkout
        run: |
          echo "ðŸ“‚ Workspace: ${{ github.workspace }}"
          ls -la
          echo "âœ… storage_utils.py exists:" && test -f storage_utils.py && echo "YES" || echo "NO"
      
      - name: Setup Python environment
        uses: ./.github/actions/setup-python-env
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCS_SERVICE_ACCOUNT_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Determine batch number
        id: batch
        run: |
          if [ -n "${{ github.event.inputs.batch }}" ]; then
            BATCH="${{ github.event.inputs.batch }}"
            echo "Running manually specified batch: $BATCH"
          else
            HOUR=$(date -u +%H)
            
            if [ "$HOUR" -eq 14 ]; then
              BATCH=1
            elif [ "$HOUR" -eq 18 ]; then
              BATCH=2
            elif [ "$HOUR" -eq 22 ]; then
              BATCH=3
            else
              BATCH=1
              echo "âš ï¸  Not a scheduled time. Defaulting to batch 1."
            fi
            
            echo "Auto-detected batch: $BATCH"
          fi
          
          echo "batch=$BATCH" >> $GITHUB_OUTPUT
      
      - name: Fetch trends data (Batch ${{ steps.batch.outputs.batch }}) (â†’ GCS)
        run: |
          echo "ðŸ“Š Fetching trends batch ${{ steps.batch.outputs.batch }}..."
          python scripts/fetch_trends_data.py \
            --batch ${{ steps.batch.outputs.batch }} \
            --batch-size 300 \
            --bucket "$GCS_BUCKET"
      
      - name: Merge batches (Batch 3 only) (â†’ GCS)
        if: steps.batch.outputs.batch == '3'
        run: |
          sleep 5
          echo "ðŸ”€ Merging all trend batches..."
          python scripts/fetch_trends_data.py --merge --bucket "$GCS_BUCKET"
      
      - name: Summary
        if: always()
        run: |
          BATCH="${{ steps.batch.outputs.batch }}"
          DATE=$(date -u +%Y-%m-%d)
          
          echo "### Trends Data Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“… **Date:** ${DATE}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **Batch:** ${BATCH}" >> $GITHUB_STEP_SUMMARY
          echo "â˜ï¸ **Bucket:** gs://$GCS_BUCKET" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Files written:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          gsutil ls -l "gs://$GCS_BUCKET/data/trends_data/" 2>/dev/null || echo "No trends files"
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
